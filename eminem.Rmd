---
title: "M&Ms simulation"
author: "James Mason"
date: "Friday, April 03, 2015"
output:
  pdf_document:
    fig_crop: no
    keep_tex: no
    number_sections: no
    toc: no
    toc_depth: 3
    dev: tikz
    fig_caption: yes
  html_document:
    toc: no
  word_document: default
header-includes:
   - \usepackage{booktabs}
   - \usepackage{caption}
   - \usepackage{fancyhdr}
   - \pagestyle{fancy}
   - \fancyhf{}
   - \fancyhead[L]{\sc\thetitle}
   - \fancyhead[R]{\sc\theauthor}
   - \fancyfoot[C]{\thepage}
   - \usepackage{pgf,tikz}
   - \usetikzlibrary{positioning}
   - \usepackage[absolute]{textpos}
   - \usepackage{sidecap}
documentclass: article
---

```{r setup, include=FALSE}
options(digits = 3)
library(R.utils)
library(xtable)
library(tikzDevice)
library(knitr)
options(xtable.comment = FALSE)
options(xtable.booktabs = TRUE)
options(xtable.caption.placement = "top")
opts_chunk$set(fig.width = 4);
opts_chunk$set(fig.height = 3); 
opts_chunk$set(fig.pos='h');
opts_chunk$set( fig.align='center');
```


This R Markdown code explores the issues with a misspecified ANOVA model
for investigating the homogeneity of the distribution of colors within
packages of M&M candies.

```{r}
library(foreach)
colors=factor(c('red', 'green', 'blue', 'yellow'))
n.candies=20            # Number of M&Ms per box
n.boxes=1000            # Number of experiments
n.replications=10000    # Number of boxes sampled in each experiment
```

The data-generating model is that boxes of M&Ms are assumed to be filled
with a _fixed_ number of candies, drawn at random from an infinite vat
containing unknown proportions of each color.
The research question is whether the colors in this vat are in
_equal proportions_, or whether those _proportions differ_.

To answer this question, a researcher proposes to draw a sample of
boxes of M&Ms, and count the numbers of each color in each box.
ANOVA would then be conducted to see if the counts
differ between the colors, using the color for group membership
and the count as the outcome variable. Thus, if there are
$c$ different colors of M&M, and $N$ boxes were sampled,
$c \times N$ data points would be entered into ANOVA,
$c$ for each box.
This model is misspecified because the count of colors
are _not independent_ within each box: for example if the
box is mostly full of blue candies, there will be less
room for each of the other colors.

For the statistical test implied by
the ANOVA model, hypothesis test is as follows:

* $H_0$: The colors in the vat are in equal proportion.
* $H_A$: At least one color in the vat has a different
proportion than the others.

In a correctly-specified model,  if the null hypothesis is true,
with a significance threshold of $\alpha$,
we would expect to obtain $p < \alpha$
(and thus falsely reject the null hypothesis)
in exactly $\alpha$ proportion of experiments. 
(For example if our significance threshold is $p<0.05$,
then we would expect to falsely reject the null 20% of
the time).  This is, in fact, the _definition_ of the
p-value, and thus
the _sampling distribution of p-values_ should have
a cumulative distribution function (CDF) which is:
$$
\begin{aligned}
  g(p) &= 1 && \text{if } 0 < p < 1   \\
  g(p) &= 0 && \text{otherwise}       \\
\end{aligned}
$$

\newpage

In this first simulation, we simulate a _correctly_ specified
ANOVA model where, for each color, we draw an independent
sample from the standard normal distribution $N(0,1)$.

```{r simulation1, fig.cap="Empiricial Distribution of p-values under simple ANOVA"  }
p.values = times (n.replications) %do% {
  # For each color, draw N standard normal deviates
  counts=data.frame(color=rep(colors, each=n.boxes),
                    count=rnorm(n.boxes*length(colors)))
  
  # To run ANOVA in R, we first fit ANOVA as a linear model using lm(),
  # then use the anova() function to compute the required F-tests.
  model=lm(count~color, data=counts)
  results=anova(model)
  
  # Next, we extract and return the p-value; these are collected by times() into a vector
  p.value=results['color','Pr(>F)']
  p.value
}

hist(p.values,
     breaks=min(20, n.replications/10),
     main=NA, freq=FALSE)
```

\newpage

In this second simulation, we simulate experiments under the
null hypothesis:
_many_ experiments are simulated in which we sample
a large number of boxes of M&Ms,
drawn from a vat with equal proportions of the colors (defined above),
and run the misspecified ANOVA described above. We then investigate
the distribution of p-values from these experiments, to see how this
distribution deviates from the expected $Uniform(0,1)$ distribution.

```{r simulation2, fig.cap="Empiricial Distribution of p-values under misspecified ANOVA"  }
p.values = times (n.replications) %do% {
  # Draw a sample from a vat with equal proportions of each color
  sample=t(replicate(n.boxes, sample(colors, n.candies, replace=TRUE)))
  
  # We count each color in each box and combine these counts into a single dataset.
  counts=data.frame(foreach(color=colors, .combine=rbind) %do%
                      data.frame(color=color,
                                 count=apply(sample, 1, function(row) sum(row == color))))
  
  # As above, we fit the model, and return the p-value.
  model=lm(count~color, data=counts)
  results=anova(model)
  p.value=results['color','Pr(>F)']
  p.value
}

hist(p.values,
     breaks=min(20, n.replications/10),
     main=NA, freq=FALSE)
```

\newpage

In this third simulation, we attempt to use ANOVA correctly
in the above situation.
Again we simulate the same null hypothesis:
_many_ experiments are simulated in which we sample
a large number of boxes of M&Ms,
drawn from a vat with equal proportions of the colors (defined above).
This time, we divide the sample into different portions,
of size $\frac{n.boxes}{n.colors}$, and count the colors in separate
fractions of the sample. Although this reduces our overall sample size,
it will mean that the counts of each color are independent of 
each other.

```{r simulation3, fig.cap="Empiricial Distribution of p-values under corrected ANOVA"  }
p.values = times (n.replications) %do% {
  # Draw a sample from a vat with equal proportions of each color
  sample=t(replicate(n.boxes, sample(colors, n.candies, replace=TRUE)))
  
  # Split the sample into equal parts for each color.
  # (We have to turn the sample into a data frame, so that split keeps
  # boxes intact, otherwise it turns the matrix into a flat vector and
  # splits that...)
  split = split(data.frame(sample), colors)
  
  # We count each color in it's separate portion, and recombine the
  # results into a single dataset.
  counts=data.frame(foreach(color=colors, .combine=rbind) %do% 
                      data.frame(color=color,
                                 count=apply(split[[color]], 1, function(row) sum(row == color))))
  
  # As above, we fit the model, and return the p-value.
  model=lm(count~color, data=counts)
  results=anova(model)
  p.value=results['color','Pr(>F)']
  p.value
}

hist(p.values,
     breaks=min(20, n.replications/10),
     main=NA, freq=FALSE)
```

