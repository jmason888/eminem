---
title: "M&Ms simulation"
author: "James Mason"
date: "Friday, April 03, 2015"
output:
  pdf_document:
    fig_crop: no
    keep_tex: no
    number_sections: no
    toc: no
    toc_depth: 3
    dev: tikz
  html_document:
    toc: no
  word_document: default
header-includes:
   - \usepackage{booktabs}
   - \usepackage{caption}
   - \usepackage{fancyhdr}
   - \pagestyle{fancy}
   - \fancyhf{}
   - \fancyhead[L]{\sc\thetitle}
   - \fancyhead[R]{\sc\theauthor}
   - \fancyfoot[C]{\thepage}
   - \usepackage{pgf,tikz}
   - \usetikzlibrary{positioning}
   - \usepackage[absolute]{textpos}
   - \usepackage{sidecap}
documentclass: article
---

This R Markdown code explores the issues with a misspecified ANOVA model
for investigating the homogeneity of the distribution of colors within
packages of M&M candies.

```{r}
colors=factor(c('red', 'green', 'blue', 'yellow'))
```

The data-generating model is that boxes of M&Ms are assumed to be filled
with a _fixed_ number of candies, drawn at random from an infinite vat
containing unknown proportions of each color.
The research question is whether the colors in this vat are in
_equal proportions_, or whether those _proportions differ_.

To answer this question, a researcher proposes to draw a sample of
boxes of M&Ms, and count the numbers of each color in each box.
ANOVA would then be conducted to see if the counts
differ between the colors, using the color for group membership
and the count as the outcome variable. Thus, if there are
$c$ different colors of M&M, and $N$ boxes were sampled,
$c \times N$ data points would be entered into ANOVA,
$c$ for each box.
This model is misspecified because the count of colors
are _not independent_ within each box: for example if the
box is mostly full of blue candies, there will be less
room for each of the other colors.

For the statistical test implied by
the ANOVA model, hypothesis test is as follows:

* $H_0$: The colors in the vat are in equal proportion.
* $H_A$: At least one color in the vat has a different
proportion than the others.

In a correctly-specified model,  if the null hypothesis is true,
with a significance threshold of $\alpha$,
we would expect to obtain $p < \alpha$
(and thus falsely reject the null hypothesis)
in exactly $\alpha$ proportion of experiments. 
(For example if our significance threshold is $p<0.05$,
then we would expect to falsely reject the null 20% of
the time).  This is, in fact, the _definition_ of the
p-value, and thus
the _sampling distribution of p-values_ should have
a cumulative distribution function (CDF) which is:
$$
\begin{aligned}
  g(p) &= 1 && \text{if } 0 < p < 1   \\
  g(p) &= 0 && \text{otherwise}       \\
\end{aligned}
$$

In this first simulation, we simulate experiments under the
null hypothesis:
_many_ experiments are simulated in which we sample
a large number of boxes of M&Ms,
drawn from a vat with equal proportions of the colors (defined above),
and run the misspecified ANOVA described above. We then investigate
the distribution of p-values from these experiments, to see how this
distribution deviates from the expected $Uniform(0,1)$ distribution.

```{r simulation1, fig.width=4  }
library(foreach)
n.boxes=1000
n.replications=100

p.values = times (n.replications) %do% {
  sample=t(replicate(n.boxes, sample(colors, 20, replace=TRUE)))
  counts=data.frame(foreach(color=colors, .combine=rbind) %do% data.frame(color=color, count=apply(sample, 1, function(row) sum(row == color))))
  lm=lm(count~color, data=counts)
  a=anova(lm)
  p.value=a['color','Pr(>F)']
  p.value
}

hist(p.values, breaks=min(100, n.replications/10), freq=FALSE)
```

